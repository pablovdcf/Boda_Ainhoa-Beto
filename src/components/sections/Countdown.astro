---
interface Props {
  targetIso: string;
  label: string;
}

const { targetIso, label } = Astro.props;
---

<section class="section" data-countdown-target={targetIso}>
  <div class="landing-container landing-container-md text-center">
    <p class="text-xs uppercase tracking-[0.24em] text-slate-500 reveal">Cuenta atrás</p>
    <h2 class="font-serif text-3xl md:text-4xl mt-3 mb-6 text-night reveal">Nos vemos pronto</h2>

    <div id="cd" class="countdown reveal reveal-delay-1 pro-countdown">
      <div class="unit">
        <div class="num" id="d">--</div>
        <div class="label">Días</div>
      </div>
      <span class="sep">•</span>
      <div class="unit">
        <div class="num" id="h">--</div>
        <div class="label">Horas</div>
      </div>
      <span class="sep">•</span>
      <div class="unit">
        <div class="num" id="m">--</div>
        <div class="label">Min</div>
      </div>
      <span class="sep">•</span>
      <div class="unit">
        <div class="num" id="s">--</div>
        <div class="label">Seg</div>
      </div>
    </div>

    <p id="countdownMeta" class="mt-5 text-slate-600 reveal reveal-delay-2">{label}</p>
  </div>
</section>

<script is:inline>
  const countdown = document.querySelector("[data-countdown-target]");
  if (countdown) {
    const targetRaw = countdown.getAttribute("data-countdown-target");
    const targetMs = new Date(targetRaw || "").getTime();
    const el = {
      d: document.getElementById("d"),
      h: document.getElementById("h"),
      m: document.getElementById("m"),
      s: document.getElementById("s")
    };

    if (!Number.isNaN(targetMs) && el.d && el.h && el.m && el.s) {
      const prev = { d: null, h: null, m: null, s: null };

      function setNum(id, value) {
        const node = el[id];
        const next = String(value).padStart(id === "d" ? 1 : 2, "0");
        if (!node || node.textContent === next) return;
        node.classList.add("fade");
        setTimeout(() => {
          node.textContent = next;
        }, 140);
        setTimeout(() => {
          node.classList.remove("fade");
        }, 320);
      }

      function tick() {
        const diff = Math.max(0, targetMs - Date.now());
        const d = Math.floor(diff / 86400000);
        const h = Math.floor((diff % 86400000) / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        if (prev.d !== d) {
          setNum("d", d);
          prev.d = d;
        }
        if (prev.h !== h) {
          setNum("h", h);
          prev.h = h;
        }
        if (prev.m !== m) {
          setNum("m", m);
          prev.m = m;
        }
        if (prev.s !== s) {
          setNum("s", s);
          prev.s = s;
        }
      }

      tick();
      setInterval(tick, 1000);
    }
  }
</script>
