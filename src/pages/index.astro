---
import { getCollection, getEntry } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import Hero from "../components/sections/Hero.astro";
import Agenda from "../components/sections/Agenda.astro";
import Story from "../components/sections/Story.astro";
import Location from "../components/sections/Location.astro";
import InfoCards from "../components/sections/InfoCards.astro";
import Gallery from "../components/sections/Gallery.astro";
import Countdown from "../components/sections/Countdown.astro";
import FAQ from "../components/sections/FAQ.astro";
import Footer from "../components/sections/Footer.astro";

const landingEntry = await getEntry("site", "landing");
if (!landingEntry) {
  throw new Error("Falta src/content/site/landing.json");
}

const agendaItems = (await getCollection("agenda")).sort(
  (a, b) => a.data.order - b.data.order
);
const faqItems = (await getCollection("faq")).sort((a, b) => a.data.order - b.data.order);
const recommendationItems = (await getCollection("recomendaciones")).sort(
  (a, b) => a.data.order - b.data.order
);
const infoItems = recommendationItems.slice(0, 3);
const data = landingEntry.data;
const heroImageSrc =
  data.location.photos[0]?.src || data.story.image.src || data.gallery[0]?.src || "/assets/hero.jpg";
const heroImageAlt = data.location.photos[0]?.alt || data.story.image.alt || data.heroTitle;
---

<BaseLayout title="Boda · Ainhoa & Alberto" description={data.heroDescription}>
  <div id="noticeBanner" class="notice-banner" role="status" aria-live="polite"></div>

  <main id="main-content" class="section-wrap landing-editorial">
    <Hero
      eyebrow={data.heroEyebrow}
      title={data.heroTitle}
      subtitle={data.heroDescription}
      ctaLabel={data.heroCtaLabel}
      ctaHref="/invite"
      heroImageSrc={heroImageSrc}
      heroImageAlt={heroImageAlt}
      secondaryCtaLabel="Ver ubicación"
      secondaryCtaHref="#locationSection"
    />

    <div class="landing-band landing-band-plain">
      <Agenda title={data.agendaTitle} items={agendaItems} />
    </div>
    <div class="landing-band landing-band-paper">
      <Story
        story={data.story}
        coupleNames={data.coupleNames || data.heroTitle}
        metaLine="San Sebastián · Verified"
      />
    </div>

    <div class="landing-band landing-band-mist">
      <Location
        title={data.location.title}
        subtitle={data.location.subtitle}
        description={data.location.description}
        mapUrl={data.venue.mapUrl}
        mapLabel={data.locationButtonLabel}
        address={`${data.venue.address}, ${data.venue.city}`}
        photos={data.location.photos}
      />
    </div>

    <div class="landing-band landing-band-plain">
      <InfoCards recommendations={infoItems} />
    </div>
    <div class="landing-band landing-band-paper">
      <Gallery title={data.galleryTitle} images={data.gallery} />
    </div>
    <div class="landing-band landing-band-plain">
      <Countdown
        targetIso={data.weddingDateIso}
        label={`${data.weddingDateLabel} — ${data.venueLine}`}
      />
    </div>
    <div class="landing-band landing-band-mist">
      <FAQ title={data.faqTitle} items={faqItems} />
    </div>
    <Footer
      title="¿Vienes a celebrarlo?"
      text="Confirma tu asistencia antes del XX de X."
      ctaLabel="Confirmar asistencia"
      ctaHref="/invite"
    />
  </main>

  <a class="sticky-cta" href="/invite">Confirmar asistencia</a>

  <script is:inline>
    (function () {
      const els = document.querySelectorAll(".reveal");
      if (!els.length) return;
      if (!("IntersectionObserver" in window)) {
        els.forEach((el) => el.classList.add("visible"));
        return;
      }
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("visible");
              observer.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.15 }
      );
      els.forEach((el) => observer.observe(el));
    })();

    (function () {
      const banner = document.getElementById("noticeBanner");
      if (!banner) return;
      const params = new URLSearchParams(location.search);
      const text = params.get("notice");
      if (!text) return;
      const kind = params.get("noticeKind") || "info";
      banner.textContent = text;
      banner.classList.remove("show", "success", "info", "warn");
      banner.classList.add(kind === "success" ? "success" : kind === "warn" ? "warn" : "info");
      requestAnimationFrame(() => banner.classList.add("show"));
      setTimeout(() => banner.classList.remove("show"), 6000);
      params.delete("notice");
      params.delete("noticeKind");
      const query = params.toString();
      history.replaceState({}, "", location.pathname + (query ? `?${query}` : ""));
    })();
  </script>
</BaseLayout>
